#!/usr/bin/env bash
# Maintainer: Autoware Foundation <contact@autoware.org>

pkgname=colcon2deb
pkgver=0.1.0
pkgrel=1
pkgdesc="Build Debian packages from colcon workspaces"
arch=('all')
url="https://github.com/autowarefoundation/colcon2deb"
license=('Apache-2.0')

depends=(
    'python3'
    'python3-yaml'
    'docker-ce'
)

makedepends=(
    'python3'
)

source=(
    "../colcon2deb-${pkgver}.tar.gz"
    "colcon2deb-wrapper.py"
    "README.md"
)

sha256sums=(
    'SKIP'
    'SKIP'
    'SKIP'
)

package() {
    # Create directories
    install -dm755 "${pkgdir}/usr/bin"
    install -dm755 "${pkgdir}/usr/share/${pkgname}/helper"
    install -dm755 "${pkgdir}/usr/share/${pkgname}/example"
    install -dm755 "${pkgdir}/usr/share/doc/${pkgname}"

    cd "${srcdir}/colcon2deb-${pkgver}"

    # Install main Python script and helper scripts to /usr/share/colcon2deb
    install -Dm755 "colcon2deb.py" "${pkgdir}/usr/share/${pkgname}/colcon2deb.py"
    cp -r "helper/"* "${pkgdir}/usr/share/${pkgname}/helper/"
    chmod 755 "${pkgdir}/usr/share/${pkgname}/helper/"*.sh

    # Install wrapper script
    install -Dm755 "${srcdir}/colcon2deb-wrapper.py" "${pkgdir}/usr/bin/colcon2deb"

    # Install example files (excluding docker/ subdirectory)
    cp -r "example/config" "${pkgdir}/usr/share/${pkgname}/example/"
    install -Dm644 "example/config.yaml" "${pkgdir}/usr/share/${pkgname}/example/config.yaml"
    
    # Install additional example config if it exists
    if [ -f "example/config-with-dockerfile.yaml" ]; then
        install -Dm644 "example/config-with-dockerfile.yaml" "${pkgdir}/usr/share/${pkgname}/example/config-with-dockerfile.yaml"
    fi

    # Install documentation
    install -Dm644 "${srcdir}/README.md" "${pkgdir}/usr/share/doc/${pkgname}/README.md"

    # Create a simple changelog
    cat > "${pkgdir}/usr/share/doc/${pkgname}/changelog" << EOF
colcon2deb (${pkgver}-${pkgrel}) unstable; urgency=low

  * Initial release

 -- Autoware Foundation <contact@autoware.org>  $(date -R)
EOF
    gzip -9 "${pkgdir}/usr/share/doc/${pkgname}/changelog"
}

# vim: set ts=4 sw=4 et: